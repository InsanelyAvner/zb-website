import time
import pinyin
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
import os
import json
import runpy
import requests

with open("data/bot.json") as f:
    CURRENT_VERSION = json.load(f)["version"]

CONTINUE = False
storylink = "https://www.zbschools.sg/stories-"

print("\nWelcome to Zki Kai's ZB Bot!")

# Check for updates
with open("data/bot.json") as f:
    CURRENT_VERSION = json.load(f)["version"]
res = requests.get("https://zb-bot.vercel.app/api/get-version")
res_json = res.json()

if res_json["version"] != CURRENT_VERSION:
    print("\nALERT: UPDATE AVAILABLE! Download the newest version at https://zb-bot.vercel.app. Remember to save your start id!\n")

if not os.path.exists("data/data.json"):
    print("\nPlease enter your ZaoBao username and password (this is a one time process)")
    inp_username = input("\nEnter your username: ")
    inp_password = input("Enter your password: ")

    with open("data/data.json", "w") as f:
        json.dump({"username": inp_username, "password": inp_password}, f)
    with open("data/start_id.txt", "w") as f:
        f.write("1")
        

with open("data/data.json") as f:
    data = json.load(f)

    username = data["username"]
    pw = data["password"]

with open("data/start_id.txt") as f:
    start_id = f.read()

if start_id != "1":
    choice = input(f"\nWould you start from where you last stopped, ID {start_id}? (y/n): ")
    if choice.lower() == "y":
        startpost = start_id
    else:
        startpost = int(input('\nEnter Start ID: '))
else:
    startpost = int(input('\nEnter Start ID (Recommended: Start from id 1 all the way to 27000, continue from where you last stopped): '))

options = Options()
driver = webdriver.Chrome(options=options)

def remove(string, removestr):
    return string.replace(removestr, "")

def Login():
    driver.get("https://www.zbschools.sg/cos/o.x?c=/ca7_zbs/user&func=login")
    time.sleep(1)
    Login = driver.find_element('xpath', "//a[@id='login']")
    Login.click()
    user = driver.find_element('id', "inputLoginId")
    user.click()
    user.send_keys(username)
    password = driver.find_element('id', "inputPassword")
    password.click()
    password.send_keys(pw)
    button = driver.find_element('id', "btn_submit")
    button.click()

def DoQuiz():
    global startpost
    driver.get(storylink + str(startpost))
    currentUrl = str(driver.current_url)
    if (currentUrl != storylink + str(startpost)):
        startpost += 1
        return
    # print(str(startpost))
    try:
        startquiz = driver.find_element('xpath', "//a[@class='btn btn-assign']")
        startquiz.click()
        time.sleep(1)
        passage = driver.find_element('xpath', "html/body/div/div/div/div/div/div[3]/div/div[1]/div[1]/div[6]").text
        passage = remove(passage, '"')
        driver.switch_to.frame('litebox_iframe')
        count = len(driver.find_elements('xpath', "/html/body/div/div/form/div"))
        for q in range(1, count):
            answer = ''
            try:
                text = driver.find_element('xpath', f"/html/body/div/div/form/div[{q}]/div[1]/div[1]/h3/span").text
            except:
                # No Question
                # print('no question')
                pass
            if ('_' in text):
                try:
                    Output = text.split('_')
                    a = passage.find(Output[0])
                    b = passage.find((Output[len(Output) - 1]))
                    r = range((b - a) - len(Output[0]))
                    answer = ''
                    for n in r:
                        answer = answer + passage[n + a + len(Output[0])]
                except:
                    # print('Crashed')
                    pass
            else:
                try:
                    tpy = driver.find_element('xpath', f"/html/body/div/div/form/div[{q}]/div[1]/div[1]/h3/span/b").text
                    answer = pinyin.get(tpy)
                except:
                    ('stop crashing')
            qcount = len(driver.find_elements('xpath', f"/html/body/div/div/form/div[{q}]/div[2]/table/tbody/tr"))
            for a in range(1, qcount + 1):
                optext = driver.find_element('xpath', f"/html/body/div/div/form/div[{q}]/div[2]/table/tbody/tr[{a}]/td[2]").text
                optext = (remove(optext, " "))
                opt = driver.find_element('xpath', f"/html/body/div/div/form/div[{q}]/div[2]/table/tbody/tr[{a}]/td[1]/input")
                if answer == optext:
                    opt.click()
        submit = driver.find_element('xpath', f"/html/body/div/div/form/div[{count}]/input")
        submit.click()
    except:
        # print(str(startpost))
        pass

    startpost += 1

    with open("data/start_id.txt", "w") as f:
        f.write(str(startpost))

Login()
while(True):
    DoQuiz()